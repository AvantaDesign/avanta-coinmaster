# Phase 21: Implementation Architecture Diagram

## ğŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AVANTA FINANCE - PHASE 21                         â”‚
â”‚                   Advanced Declarations (DIOT & CE)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            FRONTEND LAYER                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  SATDeclarations.jsx (React Component)                          â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚                                                                  â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚     â”‚
â”‚  â”‚  â”‚ Dashboard    â”‚ DIOT         â”‚ Contabilidad â”‚ History      â”‚â”‚     â”‚
â”‚  â”‚  â”‚ Tab          â”‚ Tab          â”‚ ElectrÃ³nica  â”‚ Tab          â”‚â”‚     â”‚
â”‚  â”‚  â”‚              â”‚              â”‚ Tab          â”‚              â”‚â”‚     â”‚
â”‚  â”‚  â”‚ â€¢ Summary    â”‚ â€¢ Period     â”‚ â€¢ Period     â”‚ â€¢ List       â”‚â”‚     â”‚
â”‚  â”‚  â”‚   Cards      â”‚   Selection  â”‚   Selection  â”‚   Filtering  â”‚â”‚     â”‚
â”‚  â”‚  â”‚ â€¢ Quick      â”‚ â€¢ Generate   â”‚ â€¢ Generate   â”‚ â€¢ Download   â”‚â”‚     â”‚
â”‚  â”‚  â”‚   Actions    â”‚   Button     â”‚   Button     â”‚ â€¢ Delete     â”‚â”‚     â”‚
â”‚  â”‚  â”‚              â”‚ â€¢ Info       â”‚ â€¢ File Grid  â”‚              â”‚â”‚     â”‚
â”‚  â”‚  â”‚              â”‚   Panel      â”‚              â”‚              â”‚â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚     â”‚
â”‚  â”‚                                                                  â”‚     â”‚
â”‚  â”‚  State Management:                                              â”‚     â”‚
â”‚  â”‚  â€¢ activeTab, declarations, loading                             â”‚     â”‚
â”‚  â”‚  â€¢ filterStatus, filterType, selectedPeriod                     â”‚     â”‚
â”‚  â”‚  â€¢ generatingDIOT, generatingCE                                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†• API Calls (fetch)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             API LAYER                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  /api/sat-declarations (sat-declarations.js)                             â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  HTTP Methods:                                                  â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â”‚
â”‚  â”‚  â”‚ GET      â”‚ POST     â”‚ PUT      â”‚ DELETE   â”‚ OPTIONS    â”‚   â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Endpoints:                                                     â”‚     â”‚
â”‚  â”‚  â€¢ GET    /api/sat-declarations              - List            â”‚     â”‚
â”‚  â”‚  â€¢ GET    /api/sat-declarations/:id          - Get Single      â”‚     â”‚
â”‚  â”‚  â€¢ POST   /api/sat-declarations/diot/:y/:m   - Generate DIOT   â”‚     â”‚
â”‚  â”‚  â€¢ POST   /api/sat-declarations/cont/:y/:m   - Generate CE     â”‚     â”‚
â”‚  â”‚  â€¢ POST   /api/sat-declarations/submit/:id   - Submit          â”‚     â”‚
â”‚  â”‚  â€¢ PUT    /api/sat-declarations/:id          - Update          â”‚     â”‚
â”‚  â”‚  â€¢ DELETE /api/sat-declarations/:id          - Delete          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Core Functions:                                                â”‚     â”‚
â”‚  â”‚  â€¢ listDeclarations()                                           â”‚     â”‚
â”‚  â”‚  â€¢ getSingleDeclaration()                                       â”‚     â”‚
â”‚  â”‚  â€¢ generateDIOT()              â† Main DIOT Engine               â”‚     â”‚
â”‚  â”‚  â€¢ generateContabilidadElectronica() â† Main CE Engine           â”‚     â”‚
â”‚  â”‚  â€¢ updateDeclaration()                                          â”‚     â”‚
â”‚  â”‚  â€¢ deleteDeclaration()                                          â”‚     â”‚
â”‚  â”‚  â€¢ submitDeclaration()                                          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  XML Generators:                                                â”‚     â”‚
â”‚  â”‚  â€¢ generateDIOTXML()                                            â”‚     â”‚
â”‚  â”‚  â€¢ generateCatalogoCuentasXML()                                 â”‚     â”‚
â”‚  â”‚  â€¢ generateBalanzaComprobacionXML()                             â”‚     â”‚
â”‚  â”‚  â€¢ generatePolizasXML()                                         â”‚     â”‚
â”‚  â”‚  â€¢ generateAuxiliarFoliosXML()                                  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†• SQL Queries
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DATABASE LAYER                                  â”‚
â”‚                        (Cloudflare D1 - SQLite)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Main Tables:                                                   â”‚     â”‚
â”‚  â”‚                                                                  â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚
â”‚  â”‚  â”‚ sat_declarations â”‚  â”‚ diot_operations  â”‚  â”‚ contabilidad â”‚ â”‚     â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚ _electronica â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â€¢ id             â”‚  â”‚ â€¢ id             â”‚  â”‚ _files       â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â€¢ user_id        â”‚  â”‚ â€¢ user_id        â”‚  â”‚              â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â€¢ type           â”‚  â”‚ â€¢ declaration_id â”‚  â”‚ â€¢ id         â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â€¢ period_year    â”‚  â”‚ â€¢ client_rfc     â”‚  â”‚ â€¢ user_id    â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â€¢ period_month   â”‚  â”‚ â€¢ client_name    â”‚  â”‚ â€¢ decl_id    â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â€¢ status         â”‚  â”‚ â€¢ operation_type â”‚  â”‚ â€¢ file_type  â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â€¢ xml_content    â”‚  â”‚ â€¢ nationality    â”‚  â”‚ â€¢ xml        â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â€¢ file_name      â”‚  â”‚ â€¢ amount         â”‚  â”‚ â€¢ valid_st   â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â€¢ submission_dt  â”‚  â”‚ â€¢ iva_amount     â”‚  â”‚              â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â€¢ sat_response   â”‚  â”‚ â€¢ currency       â”‚  â”‚              â”‚ â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Views:                                                         â”‚     â”‚
â”‚  â”‚  â€¢ v_declaration_summary        - Summary by period             â”‚     â”‚
â”‚  â”‚  â€¢ v_diot_operations_summary    - DIOT ops grouped              â”‚     â”‚
â”‚  â”‚  â€¢ v_pending_declarations       - Pending items                 â”‚     â”‚
â”‚  â”‚  â€¢ v_ce_file_summary            - CE file stats                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Indexes (15 total):                                            â”‚     â”‚
â”‚  â”‚  â€¢ idx_sat_declarations_user_id                                 â”‚     â”‚
â”‚  â”‚  â€¢ idx_sat_declarations_type                                    â”‚     â”‚
â”‚  â”‚  â€¢ idx_sat_declarations_period                                  â”‚     â”‚
â”‚  â”‚  â€¢ idx_sat_declarations_status                                  â”‚     â”‚
â”‚  â”‚  â€¢ idx_diot_operations_rfc                                      â”‚     â”‚
â”‚  â”‚  â€¢ idx_diot_operations_date                                     â”‚     â”‚
â”‚  â”‚  â€¢ [9 more indexes...]                                          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Triggers:                                                      â”‚     â”‚
â”‚  â”‚  â€¢ trg_sat_declarations_updated_at                              â”‚     â”‚
â”‚  â”‚  â€¢ trg_diot_operations_updated_at                               â”‚     â”‚
â”‚  â”‚  â€¢ trg_ce_files_updated_at                                      â”‚     â”‚
â”‚  â”‚  â€¢ trg_update_declaration_status_on_files                       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†• Data Source
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      INTEGRATION DATA SOURCES                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ transactions       â”‚  â”‚ cfdi_metadata      â”‚  â”‚ sat_accounts_    â”‚  â”‚
â”‚  â”‚ (Phase 17)         â”‚  â”‚ (Phase 18)         â”‚  â”‚ catalog          â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚ (Phase 17)       â”‚  â”‚
â”‚  â”‚ â€¢ Income data      â”‚  â”‚ â€¢ CFDI UUIDs       â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚ â€¢ Expense data     â”‚  â”‚ â€¢ Emitter/Receiver â”‚  â”‚ â€¢ Account codes  â”‚  â”‚
â”‚  â”‚ â€¢ Client RFC       â”‚  â”‚ â€¢ Amounts          â”‚  â”‚ â€¢ Descriptions   â”‚  â”‚
â”‚  â”‚ â€¢ IVA rates        â”‚  â”‚ â€¢ Issue dates      â”‚  â”‚ â€¢ Hierarchy      â”‚  â”‚
â”‚  â”‚ â€¢ Currency         â”‚  â”‚ â€¢ Types            â”‚  â”‚ â€¢ Nature         â”‚  â”‚
â”‚  â”‚ â€¢ Exchange rates   â”‚  â”‚                    â”‚  â”‚                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚ accounts           â”‚  â”‚ fiscal_parameters  â”‚                         â”‚
â”‚  â”‚                    â”‚  â”‚ (Phase 17)         â”‚                         â”‚
â”‚  â”‚ â€¢ Account names    â”‚  â”‚                    â”‚                         â”‚
â”‚  â”‚ â€¢ SAT codes        â”‚  â”‚ â€¢ ISR rates        â”‚                         â”‚
â”‚  â”‚ â€¢ Balances         â”‚  â”‚ â€¢ IVA rates        â”‚                         â”‚
â”‚  â”‚                    â”‚  â”‚ â€¢ UMA values       â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

## ğŸ”„ Data Flow Diagrams

### DIOT Generation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DIOT GENERATION PROCESS                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. User Input
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Select Period  â”‚
   â”‚ Year: 2025     â”‚
   â”‚ Month: Enero   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
2. Frontend Request
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ POST /api/sat-declarations/diot/2025/1 â”‚
   â”‚ Authorization: Bearer {token}          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
3. Backend Validation
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ â€¢ Validate user token        â”‚
   â”‚ â€¢ Check year range (2020+)   â”‚
   â”‚ â€¢ Check month range (1-12)   â”‚
   â”‚ â€¢ Check for duplicates       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
4. Data Extraction
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ SQL Query:                                     â”‚
   â”‚ SELECT transactions WHERE:                     â”‚
   â”‚   â€¢ date BETWEEN start_date AND end_date       â”‚
   â”‚   â€¢ client_rfc IS NOT NULL                     â”‚
   â”‚   â€¢ is_deleted = 0                             â”‚
   â”‚ GROUP BY:                                      â”‚
   â”‚   â€¢ client_rfc                                 â”‚
   â”‚   â€¢ operation_type                             â”‚
   â”‚   â€¢ iva_rate                                   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
5. Create Declaration
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ INSERT INTO sat_declarations          â”‚
   â”‚   type = 'diot'                       â”‚
   â”‚   period_year = 2025                  â”‚
   â”‚   period_month = 1                    â”‚
   â”‚   status = 'draft'                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
6. Insert Operations
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ FOR EACH grouped operation:             â”‚
   â”‚   INSERT INTO diot_operations           â”‚
   â”‚     â€¢ client_rfc                        â”‚
   â”‚     â€¢ amount, base, iva                 â”‚
   â”‚     â€¢ operation_type                    â”‚
   â”‚     â€¢ currency, exchange_rate           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
7. Generate XML
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ generateDIOTXML(operations)            â”‚
   â”‚   â€¢ Build XML header                   â”‚
   â”‚   â€¢ Add operation entries              â”‚
   â”‚   â€¢ Escape special characters          â”‚
   â”‚   â€¢ Close XML structure                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
8. Update Declaration
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ UPDATE sat_declarations SET            â”‚
   â”‚   xml_content = {xml}                  â”‚
   â”‚   file_name = 'DIOT_2025_01.xml'       â”‚
   â”‚   status = 'generated'                 â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
9. Return Response
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ JSON Response:                         â”‚
   â”‚   â€¢ declarationId                      â”‚
   â”‚   â€¢ operationCount                     â”‚
   â”‚   â€¢ xml (full content)                 â”‚
   â”‚   â€¢ success: true                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
10. Frontend Actions
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ â€¢ Show success alert               â”‚
    â”‚ â€¢ Auto-download XML file           â”‚
    â”‚ â€¢ Reload declarations list         â”‚
    â”‚ â€¢ Reset generating state           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Contabilidad ElectrÃ³nica Generation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             CONTABILIDAD ELECTRÃ“NICA GENERATION PROCESS               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. User Input â†’ 2. API Request â†’ 3. Validation â†’ 4. Create Declaration

5. Generate 4 XML Files in Parallel:

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                                                                  â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   â”‚  â”‚ CatÃ¡logo       â”‚  â”‚ Balanza        â”‚  â”‚ PÃ³lizas        â”‚   â”‚
   â”‚  â”‚ de Cuentas     â”‚  â”‚ ComprobaciÃ³n   â”‚  â”‚                â”‚   â”‚
   â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                â”‚   â”‚
   â”‚  â”‚ Data Source:   â”‚  â”‚ Data Source:   â”‚  â”‚ Data Source:   â”‚   â”‚
   â”‚  â”‚ sat_accounts   â”‚  â”‚ transactions   â”‚  â”‚ transactions   â”‚   â”‚
   â”‚  â”‚ _catalog       â”‚  â”‚ + accounts     â”‚  â”‚ + accounts     â”‚   â”‚
   â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                â”‚   â”‚
   â”‚  â”‚ Query:         â”‚  â”‚ Query:         â”‚  â”‚ Query:         â”‚   â”‚
   â”‚  â”‚ â€¢ Get all      â”‚  â”‚ â€¢ Group by     â”‚  â”‚ â€¢ All trans    â”‚   â”‚
   â”‚  â”‚   active       â”‚  â”‚   account_id   â”‚  â”‚   in period    â”‚   â”‚
   â”‚  â”‚   accounts     â”‚  â”‚ â€¢ SUM debits   â”‚  â”‚ â€¢ With dates   â”‚   â”‚
   â”‚  â”‚ â€¢ Ordered by   â”‚  â”‚ â€¢ SUM credits  â”‚  â”‚ â€¢ Sequential   â”‚   â”‚
   â”‚  â”‚   codigo       â”‚  â”‚ â€¢ Calculate    â”‚  â”‚                â”‚   â”‚
   â”‚  â”‚                â”‚  â”‚   balances     â”‚  â”‚                â”‚   â”‚
   â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                â”‚   â”‚
   â”‚  â”‚ Generate XML:  â”‚  â”‚ Generate XML:  â”‚  â”‚ Generate XML:  â”‚   â”‚
   â”‚  â”‚ â€¢ Header       â”‚  â”‚ â€¢ Header       â”‚  â”‚ â€¢ Header       â”‚   â”‚
   â”‚  â”‚ â€¢ <Ctas>       â”‚  â”‚ â€¢ <Ctas>       â”‚  â”‚ â€¢ <Poliza>     â”‚   â”‚
   â”‚  â”‚   - Cuenta     â”‚  â”‚   - Cta attrs  â”‚  â”‚   - Trans      â”‚   â”‚
   â”‚  â”‚   - Attrs      â”‚  â”‚   - Balances   â”‚  â”‚   - Debe/Haber â”‚   â”‚
   â”‚  â”‚ â€¢ Close        â”‚  â”‚ â€¢ Close        â”‚  â”‚ â€¢ Close        â”‚   â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
   â”‚           â†“                   â†“                   â†“            â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   â”‚  â”‚ Auxiliar       â”‚                      â”‚ Store in DB    â”‚   â”‚
   â”‚  â”‚ de Folios      â”‚                      â”‚                â”‚   â”‚
   â”‚  â”‚                â”‚                      â”‚ INSERT INTO    â”‚   â”‚
   â”‚  â”‚ Data Source:   â”‚                      â”‚ contabilidad   â”‚   â”‚
   â”‚  â”‚ cfdi_metadata  â”‚                      â”‚ _electronica   â”‚   â”‚
   â”‚  â”‚                â”‚                      â”‚ _files         â”‚   â”‚
   â”‚  â”‚ Query:         â”‚                      â”‚                â”‚   â”‚
   â”‚  â”‚ â€¢ All CFDIs    â”‚                      â”‚ â€¢ xml_content  â”‚   â”‚
   â”‚  â”‚   in period    â”‚                      â”‚ â€¢ file_name    â”‚   â”‚
   â”‚  â”‚ â€¢ Issue dates  â”‚                      â”‚ â€¢ file_type    â”‚   â”‚
   â”‚  â”‚ â€¢ UUIDs        â”‚                      â”‚ â€¢ validation   â”‚   â”‚
   â”‚  â”‚                â”‚                      â”‚                â”‚   â”‚
   â”‚  â”‚ Generate XML:  â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
   â”‚  â”‚ â€¢ Header       â”‚                                           â”‚
   â”‚  â”‚ â€¢ <DetAuxFol>  â”‚                                           â”‚
   â”‚  â”‚   - CompNal    â”‚                                           â”‚
   â”‚  â”‚   - UUID       â”‚                                           â”‚
   â”‚  â”‚ â€¢ Close        â”‚                                           â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
   â”‚           â†“                                                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

6. Update Declaration Status
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ UPDATE sat_declarations SET        â”‚
   â”‚   status = 'generated'             â”‚
   â”‚ WHERE id = declaration_id          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
7. Return Response
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ JSON Response:                     â”‚
   â”‚   â€¢ declarationId                  â”‚
   â”‚   â€¢ fileCount: 4                   â”‚
   â”‚   â€¢ files: [{type, id}, ...]       â”‚
   â”‚   â€¢ success: true                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—‚ï¸ File Structure

```
avanta-coinmaster/
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ 028_add_advanced_declarations.sql    â† Database schema
â”‚
â”œâ”€â”€ functions/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ sat-declarations.js               â† Backend API (1,100 lines)
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ SATDeclarations.jsx              â† Frontend UI (800 lines)
â”‚   â”‚
â”‚   â””â”€â”€ App.jsx                              â† Updated with route & nav
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ IMPLEMENTATION_PLAN_V7.md            â† Updated plan
    â”œâ”€â”€ PHASE_21_ADVANCED_DECLARATIONS_SUMMARY.md â† Complete docs
    â””â”€â”€ PHASE_21_VISUAL_SUMMARY.md           â† UI guide
```

## ğŸ” Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SECURITY LAYERS                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Authentication
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ JWT Token Validation             â”‚
   â”‚ â€¢ getUserIdFromToken()           â”‚
   â”‚ â€¢ Verify signature               â”‚
   â”‚ â€¢ Check expiration               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. Authorization
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ User Ownership Verification      â”‚
   â”‚ â€¢ Check user_id match            â”‚
   â”‚ â€¢ Prevent cross-user access      â”‚
   â”‚ â€¢ Validate resource ownership    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. Input Validation
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Parameter Validation             â”‚
   â”‚ â€¢ Year range: 2020-2100          â”‚
   â”‚ â€¢ Month range: 1-12              â”‚
   â”‚ â€¢ RFC format: min 12 chars       â”‚
   â”‚ â€¢ Status enum validation         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. SQL Injection Prevention
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Prepared Statements              â”‚
   â”‚ â€¢ All queries use .bind()        â”‚
   â”‚ â€¢ No string concatenation        â”‚
   â”‚ â€¢ Parameterized queries          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

5. XSS Prevention
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ XML Escaping                     â”‚
   â”‚ â€¢ escapeXML() function           â”‚
   â”‚ â€¢ &, <, >, ", ' encoding         â”‚
   â”‚ â€¢ Safe output generation         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

6. CORS Configuration
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Cross-Origin Controls            â”‚
   â”‚ â€¢ Allow-Origin: *                â”‚
   â”‚ â€¢ Allow-Methods: defined         â”‚
   â”‚ â€¢ Allow-Headers: specified       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Performance Optimizations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                PERFORMANCE FEATURES                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Database Level:
â”œâ”€â”€ 15 Indexes for fast queries
â”‚   â”œâ”€â”€ User-based lookups
â”‚   â”œâ”€â”€ Period-based filtering
â”‚   â”œâ”€â”€ Status filtering
â”‚   â””â”€â”€ RFC lookups
â”‚
â”œâ”€â”€ Pre-built Views
â”‚   â”œâ”€â”€ v_declaration_summary
â”‚   â”œâ”€â”€ v_diot_operations_summary
â”‚   â”œâ”€â”€ v_pending_declarations
â”‚   â””â”€â”€ v_ce_file_summary
â”‚
â””â”€â”€ Efficient Queries
    â”œâ”€â”€ Single query for operations
    â”œâ”€â”€ Grouped aggregations
    â””â”€â”€ Limited result sets

Backend Level:
â”œâ”€â”€ Lazy Loading
â”‚   â””â”€â”€ Only load data when requested
â”‚
â”œâ”€â”€ Pagination Support
â”‚   â”œâ”€â”€ limit parameter
â”‚   â””â”€â”€ offset parameter
â”‚
â””â”€â”€ Efficient XML Generation
    â””â”€â”€ String concatenation (not DOM)

Frontend Level:
â”œâ”€â”€ React Lazy Loading
â”‚   â””â”€â”€ Component loaded on demand
â”‚
â”œâ”€â”€ State Management
â”‚   â”œâ”€â”€ Minimal re-renders
â”‚   â””â”€â”€ Efficient updates
â”‚
â””â”€â”€ Conditional Rendering
    â””â”€â”€ Only active tab rendered
```

## ğŸ§ª Testing Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TESTING LEVELS                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Unit Testing (Recommended):
â”œâ”€â”€ XML Generation Functions
â”‚   â”œâ”€â”€ generateDIOTXML()
â”‚   â”œâ”€â”€ generateCatalogoCuentasXML()
â”‚   â”œâ”€â”€ generateBalanzaComprobacionXML()
â”‚   â”œâ”€â”€ generatePolizasXML()
â”‚   â””â”€â”€ generateAuxiliarFoliosXML()
â”‚
â”œâ”€â”€ Utility Functions
â”‚   â”œâ”€â”€ escapeXML()
â”‚   â”œâ”€â”€ getOperationTypeCode()
â”‚   â””â”€â”€ getTasaIVA()
â”‚
â””â”€â”€ Validation Functions
    â”œâ”€â”€ Period validation
    â”œâ”€â”€ RFC validation
    â””â”€â”€ Status validation

Integration Testing:
â”œâ”€â”€ API Endpoints
â”‚   â”œâ”€â”€ GET /api/sat-declarations
â”‚   â”œâ”€â”€ POST /api/sat-declarations/diot/:y/:m
â”‚   â”œâ”€â”€ POST /api/sat-declarations/contabilidad/:y/:m
â”‚   â””â”€â”€ PUT/DELETE operations
â”‚
â”œâ”€â”€ Database Operations
â”‚   â”œâ”€â”€ Declaration creation
â”‚   â”œâ”€â”€ Operation insertion
â”‚   â”œâ”€â”€ File storage
â”‚   â””â”€â”€ Status updates
â”‚
â””â”€â”€ Data Flow
    â”œâ”€â”€ Transaction extraction
    â”œâ”€â”€ CFDI metadata retrieval
    â””â”€â”€ Account catalog queries

End-to-End Testing:
â”œâ”€â”€ User Workflows
â”‚   â”œâ”€â”€ Generate DIOT
â”‚   â”œâ”€â”€ Generate Contabilidad
â”‚   â”œâ”€â”€ Download XML
â”‚   â””â”€â”€ Delete declaration
â”‚
â””â”€â”€ UI Interactions
    â”œâ”€â”€ Tab navigation
    â”œâ”€â”€ Period selection
    â”œâ”€â”€ Filtering
    â””â”€â”€ Loading states

Manual Testing Checklist:
â”œâ”€â”€ [ ] Generate DIOT with transactions
â”œâ”€â”€ [ ] Generate DIOT with no data
â”œâ”€â”€ [ ] Generate CE complete set
â”œâ”€â”€ [ ] Verify XML downloads
â”œâ”€â”€ [ ] Test duplicate prevention
â”œâ”€â”€ [ ] Validate XML structure
â”œâ”€â”€ [ ] Check dark mode
â””â”€â”€ [ ] Test responsive design
```

---

This architecture document provides a comprehensive technical overview of the Phase 21 implementation without requiring the application to be running.
